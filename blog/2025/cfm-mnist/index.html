<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> A Pytorch Lightning implementation of MNIST flow matching generative model | Minh-Tuan Bui </title> <meta name="author" content="Minh-Tuan Bui"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/site/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/site/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/site/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/site/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/site/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mtuanbui.github.io/site/blog/2025/cfm-mnist/"> <script src="/site/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/site/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/site/"> <span class="font-weight-bold">Minh-Tuan</span> Bui </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/site/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/site/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/site/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/site/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/site/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/site/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/site/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">A Pytorch Lightning implementation of MNIST flow matching generative model</h1> <p class="post-meta"> Created in April 05, 2025 </p> <p class="post-tags"> <a href="/site/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/site/blog/tag/flow-matching-model"> <i class="fa-solid fa-hashtag fa-sm"></i> flow-matching-model</a>   ·   <a href="/site/blog/category/implementation"> <i class="fa-solid fa-tag fa-sm"></i> implementation</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In this post, we will apply the theory of the Optimal Transport Flow Matching model, as introduced in the <a href="../cfm/">previous post</a>, to train a class-conditioned flow matching model for generating samples from the MNIST dataset distribution. We’ll use the PyTorch Lightning framework to avoid boilerplate code and focus solely on the core model logic.</p> <p>We use a UNet as the architecture for the flow matching model in this implementation. Since the main purpose is to demonstrate flow matching model training, we don’t focus on the neural network design and instead re-use the built-in UNet implementation from Diffusers library. The network architecture is similar to the one shown <a href="https://huggingface.co/learn/diffusion-course/en/unit2/3" rel="external nofollow noopener" target="_blank">here</a>, where class labels are encoded via an embedding layer, and the resulting class embeddings are concatenated to the UNet input along the channel dimension. We also modify <code class="language-plaintext highlighter-rouge">forward</code> function to support classifier-free guidance (CFG) training and utilize <code class="language-plaintext highlighter-rouge">einops</code> to reshape tensors for better clarity. The network implementation is kept as simple as the following:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td> <td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ConditionalUnet</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">class_emb_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">class_emb</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Embedding</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">class_emb_size</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">UNet2DModel</span><span class="p">(</span>
            <span class="n">sample_size</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span>
            <span class="n">in_channels</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">class_emb_size</span><span class="p">,</span>
            <span class="n">out_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">layers_per_block</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">block_out_channels</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="n">down_block_types</span><span class="o">=</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">DownBlock2D</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">AttnDownBlock2D</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">AttnDownBlock2D</span><span class="sh">"</span>
            <span class="p">),</span>
            <span class="n">up_block_types</span><span class="o">=</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">AttnUpBlock2D</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">AttnUpBlock2D</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">UpBlock2D</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">class_labels</span><span class="p">,</span> <span class="n">is_drop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">bs</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span>

        <span class="c1"># Get class embeddings
</span>        <span class="n">class_cond</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">class_emb</span><span class="p">(</span><span class="n">class_labels</span><span class="p">)</span>

        <span class="c1"># Drop conditions for CFG training
</span>        <span class="k">if</span> <span class="n">is_drop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">class_cond</span><span class="p">[</span><span class="n">is_drop</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">class_cond</span><span class="p">[</span><span class="n">is_drop</span><span class="p">])</span>

        <span class="c1"># Concatenate class embeddings to input x
</span>        <span class="n">class_cond</span> <span class="o">=</span> <span class="n">eio</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="n">class_cond</span><span class="p">,</span> <span class="sh">"</span><span class="s">bs c -&gt; bs c h w</span><span class="sh">"</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
        <span class="n">net_input</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">class_cond</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">net_input</span><span class="p">,</span> <span class="n">t</span><span class="p">).</span><span class="n">sample</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <p>We now proceed to implement model training with Pytorch Lightning. Here are some notes regarding this implementation.</p> <ul> <li>As an implementation of the Optimal Transport Flow model, a noisy image at a sampled timestep is computed by linearly interpolating between a data image and randomly sampled Gaussian noise, and the training loss is the MSE loss between the model’s prediction and \(\epsilon - \mathbf{x}\)</li> <li>Sampled timesteps are upscaled by a pre-defined factor before being input to the model</li> <li>Classifier-free guidance is employed with a condition drop rate of 0.1</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td> <td class="rouge-code"><pre><span class="k">class</span> <span class="nc">FMLitModule</span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">ConditionalUnet</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">self</span><span class="p">.</span><span class="n">eps</span> <span class="o">=</span> <span class="mf">0.006</span>
        <span class="n">self</span><span class="p">.</span><span class="n">T</span> <span class="o">=</span> <span class="mf">0.994</span>

    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>

        <span class="c1"># Randomly sample Gaussian noises
</span>        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Randomly sample timesteps ranging from eps to T
</span>        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">eps</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># get noisy images at the sampled timesteps by linear interpolation
</span>        <span class="n">noisy_x</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sigmas</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">sigmas</span> <span class="o">*</span> <span class="n">noise</span>

        <span class="c1"># Condition the model on timesteps upscaled by 1000
</span>        <span class="n">condition_timesteps</span> <span class="o">=</span> <span class="n">sigmas</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">time_scale</span>

        <span class="c1"># Let the model predict the velocities. CFG drop rate is set to be 0.1
</span>        <span class="n">pred</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">noisy_x</span><span class="p">,</span> <span class="n">condition_timesteps</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">labels</span><span class="p">,</span> <span class="n">is_drop</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># MSE loss
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="nf">mse_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">noise</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="sh">"</span><span class="s">train_loss</span><span class="sh">"</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">AdamW</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <p>We train the model on MNIST dataset for 10 epochs, with a batch size of 128 and a learning rate of 1e-3.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td> <td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MNISTData</span><span class="p">(</span><span class="n">L</span><span class="p">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="nc">Compose</span><span class="p">([</span>
            <span class="n">torchvision</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="nc">ToTensor</span><span class="p">(),</span>
            <span class="n">torchvision</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="nc">Normalize</span><span class="p">([</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">])</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mnist</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="nc">MNIST</span><span class="p">(</span>
            <span class="n">root</span><span class="o">=</span><span class="sh">"</span><span class="s">../</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">transform</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mnist</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">FMLitModule</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="nc">MNISTData</span><span class="p">()</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">L</span><span class="p">.</span><span class="n">pytorch</span><span class="p">.</span><span class="n">loggers</span><span class="p">.</span><span class="nc">TensorBoardLogger</span><span class="p">(</span><span class="sh">"</span><span class="s">tb_logs</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">flow_matching_model</span><span class="sh">"</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">L</span><span class="p">.</span><span class="nc">Trainer</span><span class="p">(</span>
    <span class="n">max_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span>
<span class="p">)</span>
<span class="n">trainer</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <div class="row"> <div class="mx-auto col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/cfm/cfm_mnist_train-480.webp 480w,/site/assets/img/cfm/cfm_mnist_train-800.webp 800w,/site/assets/img/cfm/cfm_mnist_train-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/cfm/cfm_mnist_train.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> training loss trajectory </div> <p>Given a pretrained model that predicts the velocity vector field at a given timestep, we can generate new samples by applying the Euler method to move from $x_0\sim \mathcal{N}(0,\mathbf{I})$ to a sample $x_1$ from MNIST distribution, as follows.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td> <td class="rouge-code"><pre><span class="kn">from</span> <span class="n">torchvision.transforms.functional</span> <span class="kn">import</span> <span class="n">to_pil_image</span>

<span class="n">device</span> <span class="o">=</span> <span class="sh">'</span><span class="s">mps</span><span class="sh">'</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span>

<span class="n">litmodule</span> <span class="o">=</span> <span class="nc">FMLitModule</span><span class="p">()</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">/path/to/checkpoint</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">map_location</span><span class="o">=</span><span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">weights_only</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>
<span class="n">litmodule</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span>
    <span class="n">ckpt</span><span class="p">[</span><span class="sh">'</span><span class="s">state_dict</span><span class="sh">'</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">litmodule</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
<span class="n">litmodule</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">torch</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">num_inference_steps</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">cfg_scale</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">inference_mode</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">8</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]).</span><span class="nf">flatten</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">is_drop</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]).</span><span class="nf">bool</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">t_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">litmodule</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">num_inference_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t_cur</span><span class="p">,</span> <span class="n">t_next</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">tqdm</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">t_steps</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))):</span>

        <span class="n">x_</span> <span class="o">=</span> <span class="n">eio</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="sh">'</span><span class="s">b c h w -&gt; (2 b) c h w</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">y_</span> <span class="o">=</span> <span class="n">eio</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">b -&gt; (2 b)</span><span class="sh">'</span><span class="p">)</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="n">litmodule</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">t_cur</span> <span class="o">*</span> <span class="n">litmodule</span><span class="p">.</span><span class="n">time_scale</span><span class="p">,</span> <span class="n">y_</span><span class="p">,</span> <span class="n">is_drop</span><span class="p">)</span>

        <span class="n">pred_pos</span><span class="p">,</span> <span class="n">pred_neg</span> <span class="o">=</span> <span class="n">pred</span><span class="p">.</span><span class="nf">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">cfg_scale</span> <span class="o">*</span> <span class="n">pred_pos</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cfg_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">pred_neg</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">t_next</span> <span class="o">-</span> <span class="n">t_cur</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">pred</span>

<span class="n">img_grid</span> <span class="o">=</span> <span class="n">eio</span><span class="p">.</span><span class="nf">rearrange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="sh">'</span><span class="s">(m n) 1 h w -&gt; (m h) (n w)</span><span class="sh">'</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">10</span><span class="p">).</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nf">to_pil_image</span><span class="p">(</span><span class="n">img_grid</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <div class="row"> <div class="mx-auto col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/cfm/cfm_mnist_sample-480.webp 480w,/site/assets/img/cfm/cfm_mnist_sample-800.webp 800w,/site/assets/img/cfm/cfm_mnist_sample-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/cfm/cfm_mnist_sample.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> samples generated by the trained model using 15 inference steps and CFG scale of 3.0 </div> <p>For the complete training and inference code, please refer to <a href="https://colab.research.google.com/drive/1ieHUpYbizrBWP4ilUf11d5wcWBdoCufi?usp=sharing" rel="external nofollow noopener" target="_blank">this Jupyter notebook</a></p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Minh-Tuan Bui. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/site/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/site/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/site/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/site/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/site/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/site/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/site/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/site/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/site/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/site/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/site/assets/js/search-data.js"></script> <script src="/site/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>