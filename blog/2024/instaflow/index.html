<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> InstaFlow: one step is enough for high-quality diffusion-based text-to-image generation | Minh-Tuan Bui </title> <meta name="author" content="Minh-Tuan Bui"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/site/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/site/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/site/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/site/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/site/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mtuanbui.github.io/site/blog/2024/instaflow/"> <script src="/site/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/site/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" integrity="sha256-q9ba7o845pMPFU+zcAll8rv+gC+fSovKsOoNQ6cynuQ=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css" integrity="sha256-Oppd74ucMR5a5Dq96FxjEzGF7tTw2fZ/6ksAqDCM8GY=" crossorigin="anonymous" media="screen and (prefers-color-scheme: light)"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" integrity="sha256-nyCNAiECsdDHrr/s2OQsp5l9XeY2ZJ0rMepjCT2AkBk=" crossorigin="anonymous" media="screen and (prefers-color-scheme: dark)"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/css/diff2html.min.css" integrity="sha256-IMBK4VNZp0ivwefSn51bswdsrhk0HoMTLc2GqFHFBXg=" crossorigin="anonymous"> <link defer rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css"> <script src="/site/assets/js/distillpub/template.v2.js"></script> <script src="/site/assets/js/distillpub/transforms.v2.js"></script> <script src="/site/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "InstaFlow: one step is enough for high-quality diffusion-based text-to-image generation",
            "description": "",
            "published": "July 16, 2024",
            "authors": [
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/site/"> <span class="font-weight-bold">Minh-Tuan</span> Bui </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/site/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/site/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/site/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/site/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/site/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/site/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/site/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>InstaFlow: one step is enough for high-quality diffusion-based text-to-image generation</h1> <p></p> </d-title> <d-article> <p><a href="https://arxiv.org/abs/2309.06380" rel="external nofollow noopener" target="_blank">InstaFlow</a> introduces a method to transform a many-step diffusion model into a high-quality one-step generative model. The core concept involves applying a reflow process to straighten the flow trajectories before distillation training.</p> <h2 id="background">Background</h2> <p>Background in Flow Matching, Rectified Flow and Reflow is helpful to fathom the idea behind InstaFlow.</p> <h3 id="flow-matching">Flow Matching</h3> <p>The score-based model shows that diffusion process can be expressed as an ordinary differential equation (ODE) which is indirectly learned via score-matching:</p> \[\mathrm{d}x = \left[ f(x,t) - \frac{1}{2} g(t)^2 \nabla_x \log p_t(x) \right] \mathrm{d}t\] <p>In a nutshell Flow matching directly learn that ODE, i.e. it leans what inside the bracket</p> <p>Given $\pi_0$ as a standard Gaussian distribution and $\pi_1$ as the image data distribution. Flow matching learns to transfer $\pi_0$ to $\pi_1$ via an ODE:</p> \[\frac{\mathrm{d}X_t}{\mathrm{d}t}=\mathcal{v}(X_t,t)\] <p>such that if the initial $X_0 \sim \pi_0$ then $X_1 \sim \pi_1$. The velocity field $\mathcal{v}$ is learned by minimizing a simple mean square objective:</p> \[\min_\mathcal{v}\mathbb{E}_{(X_0,X_1) \sim \gamma} \left[ \int_0^1 ||\frac{\mathrm{d}}{\mathrm{d}t}X_t - \mathcal{v}(X_t,t)||^2 \mathrm{d}t \right] \tag{1}\] <p>where $X_t = \phi (X_0, X_1, t)$ is an interpolation function between $X_0$ and $X_1$ that is differentiable w.r.t timestep $t$. Commonly $\phi$ has the form</p> \[X_t = \phi (X_0, X_1, t)=\alpha_tX_0 + \beta_t X_1\] <p>The specific choice of $\alpha_t,\beta_t$ make different flow models.</p> <h3 id="rectified-flow">Rectified Flow</h3> <p>Rectified Flow model suggests a special choice of $\phi$</p> \[X_t = \phi (X_0, X_1, t)= (1-t)X_0+ tX_1\] <p>which entails</p> \[\frac{\mathrm{d}X_t}{\mathrm{d}t}=X_1-X_0=const\] <p>As a result, the trajectory from $X_0$ to $X_1$ is contrainsted to a straight line, which is advantageous for ODE integration as it allows for the use of larger integration steps without compromising accuracy.</p> <h3 id="reflow">Reflow</h3> <p>Training a rectified flow using Equation 1 alone would not lead to a satisfactorily straight flow model. Study in <a href="https://arxiv.org/abs/2209.03003" rel="external nofollow noopener" target="_blank">https://arxiv.org/abs/2209.03003</a> suggests that we can enhance the straightness by recursively applying the rectifying procedure, as shown in the image below.</p> <div class="row"> <div class="mx-auto col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/instaflow/reflow-480.webp 480w,/site/assets/img/instaflow/reflow-800.webp 800w,/site/assets/img/instaflow/reflow-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/instaflow/reflow.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Reflow procedure. The image is from <a href="https://arxiv.org/abs/2209.03003" rel="external nofollow noopener" target="_blank">https://arxiv.org/abs/2209.03003</a> </div> <h2 id="instaflow">InstaFlow</h2> <div class="row"> <div class="mx-auto col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/instaflow/overview-480.webp 480w,/site/assets/img/instaflow/overview-800.webp 800w,/site/assets/img/instaflow/overview-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/instaflow/overview.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>InstaFlow’s main find is: Direct distillation fails, while reflow + distillation succeeds, from which they proposes a 2-steps method to train a one-step denoising model</p> <h3 id="step-1-straighten-a-pretrained-text-conditioned-model-via-text-conditioned-reflow">Step 1: straighten a pretrained text-conditioned model via text-conditioned reflow</h3> <p>Given a pretrained text-to-image models, e.g. Stable Diffusion, this step applies Reflow to improve straightness of the model as below</p> <div class="row"> <div class="mx-auto col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/instaflow/reflow_loss-480.webp 480w,/site/assets/img/instaflow/reflow_loss-800.webp 800w,/site/assets/img/instaflow/reflow_loss-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/instaflow/reflow_loss.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row"> <div class="mx-auto col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/instaflow/reflow_alg-480.webp 480w,/site/assets/img/instaflow/reflow_alg-800.webp 800w,/site/assets/img/instaflow/reflow_alg-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/instaflow/reflow_alg.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Intuitively the Reflow attempts to keep the reflowed ODE coincided with the pretrained ODE while make it as straight as possible. The training of this step relies solely on synthetic data generated by simulating the pretrained ODE which makes pairs of $(X_0,X_1)$.</p> <p>Figure 6 of the paper presents a comparison between before and after reflowing the SD 1.4 model.</p> <div class="row"> <div class="mx-auto col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/instaflow/reflow_example-480.webp 480w,/site/assets/img/instaflow/reflow_example-800.webp 800w,/site/assets/img/instaflow/reflow_example-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/instaflow/reflow_example.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>It can be seen that after reflow, straightness has been significantly improved. However, there has also been a slight change in the start and end points of the trajectories. I speculate that this represents a trade-off between high straightness without intersection and consistency with the initial flow.</p> <h3 id="step-2-text-conditioned-distillation">Step 2: text-conditioned distillation</h3> <p>While improving straightness, a limited number of iterations of step 1 cannot achieve perfect linear flow, resulting in an unusable one-step generation as illustrated in Figure 7 in the paper (the middle subfigure in the bottom row). To address this, the authors propose the following distillation technique.</p> <div class="row"> <div class="mx-auto col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/instaflow/distill_loss-480.webp 480w,/site/assets/img/instaflow/distill_loss-800.webp 800w,/site/assets/img/instaflow/distill_loss-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/instaflow/distill_loss.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row"> <div class="mx-auto col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/site/assets/img/instaflow/distill_alg-480.webp 480w,/site/assets/img/instaflow/distill_alg-800.webp 800w,/site/assets/img/instaflow/distill_alg-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/site/assets/img/instaflow/distill_alg.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>This means learning a single Euler step mapping $X_0$ to $\mathrm{ODE}[ \mathcal{v}_k ](X_0 \vert \mathcal{T})$ by minimizing a similarity loss $\mathbb{D}$. In the paper’s experiment, the similarity loss is LPIPS loss.</p> <p>Moreover, the author emphasizes that this step 2 will not be effective without step 1. The reason is that reflow has created a better coupling compared to the original flow in terms of transport costs, which makes it easier to train the student network.</p> <h2 id="limitations">Limitations</h2> <p>InstaFlow has few limitations:</p> <ul> <li>High cost of synthesizing and storing the dataset</li> <li>Reliance on a synthetic training dataset</li> <li>Inferior image quality compared to the original model</li> </ul> <p>These limitations have been addressed in their <a href="https://arxiv.org/abs/2405.07510" rel="external nofollow noopener" target="_blank">subsequent work</a></p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/site/assets/bibliography/2018-12-22-distill.bib"></d-bibliography> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Minh-Tuan Bui. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/site/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10.7.0/dist/mermaid.min.js" integrity="sha256-TtLOdUA8mstPoO6sGvHIGx2ceXrrX4KgIItO06XOn8A=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js" integrity="sha256-1rA678n2xEx7x4cTZ5x4wpUCj6kUMZEZ5cxLSVSFWxw=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/mermaid-setup.js?38ca0a0126f7328d2d9a46bad640931f" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/js/diff2html-ui.min.js" integrity="sha256-eU2TVHX633T1o/bTQp6iIJByYJEtZThhF9bKz/DcbbY=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/diff2html-setup.js?80a6e52ce727518bbd3aed2bb6ba5601" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js" integrity="sha256-MgH13bFTTNqsnuEoqNPBLDaqxjGH+lCpqrukmXc8Ppg=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/leaflet-setup.js?b6313931e203b924523e2d8b75fe8874" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha256-0q+JdOlScWOHcunpUk21uab1jW7C1deBQARHtKMcaB4=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/chartjs-setup.js?183c5859923724fb1cb3c67593848e71" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js" integrity="sha256-QvgynZibb2U53SsVu98NggJXYqwRL7tg3FeyfXvPOUY=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/theme/dark-fresh-cut.js" integrity="sha256-sm6Ui9w41++ZCWmIWDLC18a6ki72FQpWDiYTDxEPXwU=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/echarts-setup.js?738178999630746a8d0cfc261fc47c2c" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/vega@5.27.0/build/vega.min.js" integrity="sha256-Yot/cfgMMMpFwkp/5azR20Tfkt24PFqQ6IQS+80HIZs=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/vega-lite@5.16.3/build/vega-lite.min.js" integrity="sha256-TvBvIS5jUN4BSy009usRjNzjI1qRrHPYv7xVLJyjUyw=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/vega-embed@6.24.0/build/vega-embed.min.js" integrity="sha256-FPCJ9JYCC9AZSpvC/t/wHBX7ybueZhIqOMjpWqfl3DU=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/vega-setup.js?7c7bee055efe9312afc861b128fe5f36" type="text/javascript"></script> <script defer src="https://tikzjax.com/v1/tikzjax.js" integrity="sha256-+1qyucCXRZJrCg3lm3KxRt/7WXaYhBid4/1XJRHGB1E=" crossorigin="anonymous"></script> <script src="/site/assets/js/typograms.js?062e75bede72543443762dc3fe36c7a5"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/site/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/site/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/site/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/site/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/site/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/site/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/site/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/site/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/site/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/site/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/site/assets/js/search-data.js"></script> <script src="/site/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>